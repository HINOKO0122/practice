<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リズム正確度チェッカー</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .controls { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        input { width: 60px; padding: 8px; font-size: 1.2rem; text-align: center; }
        .tap-zones { display: flex; gap: 10px; height: 200px; }
        .zone { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px dashed #ccc; border-radius: 10px; cursor: pointer; user-select: none; transition: background 0.1s; }
        .zone:active, .zone.active { background: #e0e0e0; }
        #left-zone { border-color: #ff4757; color: #ff4757; }
        #right-zone { border-color: #2e86de; color: #2e86de; }
        .results { margin-top: 20px; font-size: 1.2rem; }
        .score { font-size: 2rem; font-weight: bold; color: #2ed573; }
        button { padding: 10px 20px; font-size: 1rem; cursor: pointer; background: #333; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>リズム正確度計測</h2>
    <p>BPMを設定して「開始」後、リズムに合わせて叩いてください</p>
    
    <div class="controls">
        <div class="input-group">
            <label>BPM</label>
            <input type="number" id="bpm" value="120">
        </div>
        <div class="input-group">
            <label>左手 (拍)</label>
            <input type="number" id="left-beat" value="3">
        </div>
        <div class="input-group">
            <label>右手 (拍)</label>
            <input type="number" id="right-beat" value="2">
        </div>
    </div>

    <button id="start-btn">計測開始 (5秒間)</button>

    <div class="tap-zones">
        <div id="left-zone" class="zone">左手 (Sキー)</div>
        <div id="right-zone" class="zone">右手 (Lキー)</div>
    </div>

    <div class="results">
        <div>左手正確度: <span id="left-score" class="score">0</span>%</div>
        <div>右手正確度: <span id="right-score" class="score">0</span>%</div>
    </div>
</div>

<script>
    let isRunning = false;
    let startTime;
    let leftTaps = [], rightTaps = [];
    const duration = 5000; // 5秒間計測

    const startBtn = document.getElementById('start-btn');
    const bpmInput = document.getElementById('bpm');
    const leftBeatInput = document.getElementById('left-beat');
    const rightBeatInput = document.getElementById('right-beat');

    function handleTap(side) {
        if (!isRunning) return;
        const now = performance.now() - startTime;
        if (side === 'left') {
            leftTaps.push(now);
            visualFeedback('left-zone');
        } else {
            rightTaps.push(now);
            visualFeedback('right-zone');
        }
    }

    function visualFeedback(id) {
        const el = document.getElementById(id);
        el.classList.add('active');
        setTimeout(() => el.classList.remove('active'), 50);
    }

    // キーボード操作
    window.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 's') handleTap('left');
        if (e.key.toLowerCase() === 'l') handleTap('right');
    });

    // タッチ操作
    document.getElementById('left-zone').addEventListener('mousedown', () => handleTap('left'));
    document.getElementById('right-zone').addEventListener('mousedown', () => handleTap('right'));

    startBtn.onclick = () => {
        isRunning = true;
        leftTaps = [];
        rightTaps = [];
        startBtn.disabled = true;
        startBtn.innerText = "計測中...";
        
        startTime = performance.now();

        setTimeout(() => {
            isRunning = false;
            startBtn.disabled = false;
            startBtn.innerText = "計測開始 (5秒間)";
            calculateScore();
        }, duration);
    };

    function calculateScore() {
        const bpm = parseInt(bpmInput.value);
        const beatMs = 60000 / bpm;
        
        const calcSideScore = (taps, division) => {
            if (taps.length === 0) return 0;
            const targetInterval = beatMs / (division / 4); // 4分音符基準の簡易計算
            let totalError = 0;
            
            taps.forEach(tapTime => {
                const nearestTarget = Math.round(tapTime / targetInterval) * targetInterval;
                const error = Math.abs(tapTime - nearestTarget);
                totalError += Math.min(error, targetInterval / 2);
            });

            const avgError = totalError / taps.length;
            const accuracy = Math.max(0, 100 - (avgError / (targetInterval / 2) * 100));
            return accuracy.toFixed(1);
        };

        document.getElementById('left-score').innerText = calcSideScore(leftTaps, parseInt(leftBeatInput.value));
        document.getElementById('right-score').innerText = calcSideScore(rightTaps, parseInt(rightBeatInput.value));
    }
</script>

</body>
</html>
